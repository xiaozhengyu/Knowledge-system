# 分布式锁

## 1、排它锁

排他锁（Exclusive Locks），又被称为写锁或独占锁，如果事务 T1 对数据对象 O1 加上排他锁，那么整个加锁期间，只允许事务 T1 对 O1 进行读取和更新操作，其他任何事务都不能进行读或写。



利用 Zookeeper 同级节点的唯一性特性实现排它锁：在需要获取排它锁时，所有客户端通过 create 命令创建一个临时节点

```
create -e /exclusive_lock/lock
```

最终只有一个客户端能够创建成功，那么此客户端就获得了分布式锁。同时，其他没有获取到锁的客户端可以在 /exclusive_lock 节点上注册一个子节点变更的 watcher 监听事件，以便重新争取获得锁。



## 2、共享锁

共享锁（Shared Locks），又称读锁。如果事务 T1 对数据对象 O1 加上了共享锁，那么当前事务只能对 O1 进行读取操作，其他事务也只能对这个数据对象加共享锁，直到该数据对象上的所有共享锁都释放。



定义锁：

```
/shared_lock/[hostname]-请求类型W/R-序号
```



实现方式：

1.   客户端通过 create 命令创建临时顺序节点

     ```
     create -s /shared_lock/[hostname]
     ```

     ![img](markdown/Zookeeper 实战 - 分布式锁.assets/lock-01.png)

2.   客户端通过 get 命令获取已创建的子节点列表

     ```
     get /shared_lock
     ```

     判断是否获得锁：

     -   对于读请求，如果所有序号比自己小的子节点都是读请求（或者没有比自己序号小的子节点），表明已经成功获得共享锁
     -   对于写请求，如果自己不是序号最小的子节点，那么就进入等待

3.   如果没有获取到共享锁，读请求向比自己序号小的最后一个写请求节点注册 watcher 监听，写请求向比自己序号小的最后一个节点注册 watcher 监听。

