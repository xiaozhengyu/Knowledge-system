# 分布式理论：CAP、BASE

参考文章：

1.  [分布式理论：BASE理论](https://baijiahao.baidu.com/s?id=1634401106583534524&wfr=spider&for=pc)
2.  [从分布式一致性谈到CAP理论、BASE理论](https://www.cnblogs.com/szlbm/p/5588543.html)
3.  [Zookeeper系列（1）--分布式一致性理论，CAP，BASE理论](https://blog.csdn.net/u013679744/article/details/78674779)

---

## 背景

在数据库中数据一致性通常指关联数据的一致性和完整性，那么，分布式一致性指的是什么？为什么会出现一致性问题？在探究分布式一致性理论前有必要先捋清这些问题。



### 分布式概念

随着大型网站各种高并发访问、海量数据处理的业务场景越来越多，如何实现网站的高可用、易伸缩、可扩展等目标就显得愈发重要。为了解决这一系列问题，大型网站的架构也在不断调整。提到大型网站的高可用架构，不得不提的就是分布式。

**集中式系统**

<u>集中式系统用一句话概括就是：一个主机带多个终端。</u>终端没有数据处理能力，仅负责数据的I/O，而运算、存储等操作全部由主机负责处理。集中式系统的最大的特点就是部署结构非常简单，底层一般采用从IBM、HP等厂商购买到的昂贵的大型主机。因此无需考虑如何对服务进行多节点的部署，也就不用考虑各节点之间的分布式协作问题。但是，由于采用单机部署。很可能带来系统大而复杂、难于维护、发生单点故障（单个点发生故障的时候会波及到整个系统或者网络，从而导致整个系统或者网络的瘫痪）、扩展性差等问题。

**分布式系统**

<u>分布式系统是一个硬件或软件组件分布在不同的网络计算机上，彼此之间仅仅通过消息传递进行通信和协调的系统。</u>可以将不同的业务模块，数据进行水平切分部署。分布式意味着可以采用更多的普通计算机（相对于昂贵的大型机）组成分布式集群对外提供服务。计算机越多，CPU、内存、存储资源等也就越多，能够处理的并发访问量也就越大。

集中式系统，主要流行于上个世纪。现在的银行系统，大多是这种集中式系统。对于淘宝、微博、微信等具有海量用户和复杂业务的的系统，且不提耦合严重，难于维护，单是这庞大的并发量，集中式系统根本就扛不住，所以必须进行分布式。从09年开始，阿里就开始“去IOE”，其电商系统正式迈入分布式系统时代。



### 分布式环境

<mark>我们必须明确一个现状：网络是不可靠的，网络分区以及节点宕机是常态，另外带宽资源是宝贵的，我们需要这种环境下构建高可用、高性能的分布式系统。</mark>

分布式环境具有一下问题：

1.  **通信异常**

    从集中式系统向分布式系统演变，必然要引入网络问题——分布式系统需要在各个节点之间进行网络通信，而网络是不可靠的，消息丢失、消息延时等问题非常普遍。

2.  **网络分区（脑裂）**

    当网络异常导致分布式系统中部分节点间的通信延时越来越大，并最终导致组成分布式系统的所有节点中只有部分节点可以正常相互通讯，这种情况被成为网络分区，也称脑裂。出现网络分区时，分布式系统将出现多个局部小集群（多个小集群可能又会产生多个leader节点）。分布式系统要求这些小集群要能独立完成原本需要整个分布式系统才能完成的功能，这对分布式一致性提出了非常大的挑战。

3.  **节点故障**

    节点宕机是分布式环境中的常态，每个节点在任何时刻都有可能会出现宕机或僵死的情况。

4.  **三态**

    在集中式系统中，由于没有网络因素，程序的每一次调用都能得到“成功”或者“失败”的响应，但是在分布式系统中，由于网络的不可靠性，还可能出现“超时”的情况。消息可能在发送过程丢失也可能在响应过程丢失，当出现超时情况时，网络通信的发起方是无法确定当前请求是否被成功处理的，所以这也是分布式事务的难点。

    

## 分布式数据一致性问题

由于节点宕机是常态，为了保证分布式系统的高可用性，我们一般会部署多台服务器（集群化），而这势必会出现数据复制问题。分布式系统对于数据复制的需求主要有以下原因：

1.  高可用：将数据复制到多台机器，可以消除单点故障，避免系统由于某些机器宕机导致的不可用。（鸡蛋不能放在一个框里）
2.  高性能：通过负载均衡技术，将数据访问压力分散到各个具有数据副本的节点，有效提高系统性能。

<u>在分布式系统引入复制机制后，不同的数据节点之间由于网络延时等原因很容易出现数据不一致的情况。对分布式数据一致性简单的解释就是：当对集群中一个副本数据进行更新的同时，必须确保更新能够同步到其他副本，否则不同副本之间的数据将不再一致。常见的，如：主从数据库之间的复制延时问题。</u>

分布式事务是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分散在分布式系统的不同节点上。通常一个分布式事务会涉及对多个数据源或者业务系统的操作（MySQL的主从复制能否看作分布式事务的一种呢？）

对于本地事务的处理，我们可以采用数据库ACID模型来保证数据的严格一致性（事务概念上的）；在分布式系统中，当我们要求数据具有严格一致性时，很可能需要牺牲掉系统的可用性。 <u>如何构建一个兼顾可用性和一致性的分布式系统成为无数工程师探讨的问题，所以出现了诸如CAP和BASE这样的分布式系统经典理论。</u>

### CAP

CAP原则又称CAP定理，指的是在分布式系统中，一致性、可用性、分区容忍性最多智能同时实现两点。

-   **Consistency**

    “All notes see the same data at the same time”，每次读操作都能保证返回的是最新数据。在分布式系统中意味着写操作需要立刻将结果同步到所有节点（就好比你发了一条微博，所有人要马上可以看到）

-   **Availability**

    “Read and writes always succeed”，服务总是可用的，任何请求总是能在有限时间内得到有效结果。可用性通常与分布式数据冗余、负载均衡等紧密关联。

-   **Partition-tolerance**

    “the system continues to operate despite arbitrary message loss or failure of part of the system”，系统中任意信息的丢失或失败不会影响系统的继续运作。

### BASE

