# 加密数据与模糊查询

>   原文地址：https://ningyu1.github.io/20201230/encrypted-data-fuzzy-query.html



项目中经常会遇到一些敏感数据，例如，手机号、身份证号、住址、银行卡号。对于这类敏感信息，如果直接使用明文存储是十分危险的，通常会先对数据进行加密，再将密文存储到数据库。然后，新的问题又来了——如何对加密后的数据进行模糊查询。



[TOC]



## 沙雕方案

-   方案1：先将所有数据加载进内存进行解密，然后对解密后的数据进行模糊匹配

    分析：如果数据量很小，可以考虑这种方案，如果数据量很大……



-   方案2：~~创建一个 【明文->密文】 映射表，先到映射表进行模糊匹配，然后在根据匹配结果到数据库检索数据~~

    分析：？？？那加密的意义在哪里？



## 常规方案

-   方案1：在数据库实现对应的解密算法，修改模糊查询条件——先调用解密算法对数据进行解密，然后进行模糊匹配

    

    ```mysql
    select * 
    from xxx
    where decode_method(encode_field) like '%partial%'
    ```

    分析：本方案跟“沙雕方案1”很像，但将处理数据的压力转移给了数据库

    -   优点：实现成本低，使用成本低（只需要对以往的模糊查找进行略微修改即可）
    -   缺点：没法利用索引对查询进行优化；有些数据库没法实现解密算法



-   方案2：加密数据前对数据进行固定长度的分词，然后将所有分词结果进行加密、拼接，在数据表中添加一个字段存储拼接好的分词密文。模糊查询的时候先对查询条件进行加密，然后与分词密文进行模糊匹配。

    

    示例：

    ```
    号码明文：13149334344
    
    号码分词：[1314, 3149, 1493, 4933, 9334, 3343, 3434, 4344]
    
    号码密文：39E1C1A0FFC0E277B48A40BED24CD9A8
    
    分词密文：[5B90CEC04BFD55B2C15B23DA541675D1, 47D18FEF2788970BA137D8233381E132, 3007D6AA4F902B388C20B06063551207, 24908FF39DA3ABA2D86C911E524789F4, 138791560FA0A4BBAA5267D5F42D9BCA, ED4924D606BAFE1DBBCDA37E10672F67, 2C9A572C9BC7334DC1D27B24D6971B13, DA0DBA896C6046EECF8B9204FB5584D7]
    ```

    分析：空间换时间

    -   分词的粒度、数量决定了模糊查找的精度。以上面的例子为例，只支持4位的模糊查询
    -   需要额外的空间存储分词密文，因此加密算法变得非常关键。以上面的例子为例，使用的是 AES 算法，其实可以换成 MD5 ，因为 MD5 得到的密文更短一些。
    -   这个方案其实是目前比较主流的解决方案，一些大厂也在用：
        -   [淘宝密文字段检索方案](https://open.taobao.com/docV3.htm?docId=106213&docType=1)
        -   [阿里巴巴文字段检索方案](https://jaq-doc.alibaba.com/docs/doc.htm?treeId=1&articleId=106213&docType=1)
        -   [拼多多密文字段检索方案](https://open.pinduoduo.com/application/document/browse?idStr=3407B605226E77F2)
        -   [京东密文字段检索方案](https://jos.jd.com/commondoc?listId=345)
