# 延迟写（Delayed Write）

原文地址：https://www.jb51.net/article/101062.htm

---

**延迟写（delayed write）:** 传统的UNIX实现在内核中设有缓冲区高速缓存或页面高速缓存，大多数磁盘I/O都通过缓冲进行。  当将数据写入文件时，内核通常先将该数据复制到其中一个缓冲区中，如果该缓冲区尚未写满，则  并不将其排入输出队列，而是等待其写满或者当内核需要重用该缓冲区以便存放其他磁盘块数据时，  再将该缓冲排入到输出队列，然后待其到达队首时，才进行实际的I/O操作。这种输出方式就被称为延迟写。



==延迟写减少了磁盘读写次数，但是却降低了文件内容的更新速度，使得欲写到文件中的数据在一段时间内并没有写到磁盘上。当系统发生故障时，这种延迟可能造成文件更新内容的丢失。==为了保证磁盘上实际文件系统与缓冲区高速缓存中内容的一致性，unix系统提供了三个函数：

```c
#include<unistd.h>
void sync(void);
int fsync(int filedes);
int fdatasync(int filedes);
```

1.   sync

     sync函数只是将所有修改过的块缓冲区排入写队列，==然后就返回，它并不等待实际写磁盘操作结束==。通常称为update的系统守护进程会周期性地（一般每隔30秒）调用sync函数。这就保证了定期冲洗内核的块缓冲区。命令sync(1)也调用sync函数。

2.   fsync

     fsync函数只对由文件描述符filedes指定的单一文件起作用，==并且等待写磁盘操作结束，然后返回==。fsync可用于数据库这样的应用程序，这种应用程序需要确保将修改过的块立即写到磁盘上。

3.   fdatasync

     fdatasync函数类似于fsync，但它只影响文件的数据部分。而除数据外，fsync还会同步更新文件的属性。对于提供事务支持的数据库，在事务提交时，都要确保事务日志（包含该事务所有的修改操作以及一个提交记录）完全写到硬盘上，才认定事务提交成功并返回给应用层。