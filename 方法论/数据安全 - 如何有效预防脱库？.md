# 如何有效预防脱库？

>   参考文章：https://ningyu1.github.io/20201229/datasource-security.html



[TOC]



>   脱库：指黑客入侵有价值的网络站点，将注册用户的资料数据库全部盗走的行为



“XX论坛泄露了用户密码”、“XX物流公司泄露了用户的手机号码”… 类似的消息时有爆出，作为开发人员，有必要分析这些“悲剧”背后的原因并防患于未然。



## 一、预防方向



数据库的用户可分为 2 类 —— 程序、人员，我们可以以此入手，分析如何预防脱库。

-   软件：应用程序、数据库中间件
-   人员：开发、运维、测试、产品…



## 二、预防措施



### 2.1 软件层面



#### 数据库信息加密



```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://127.0.0.1:3306/hello_world?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=UTF-8&useSSL=false
    username: root
    password: 123456
```

无论是使用配置文件还是配置中心，只要是明文就无法规避数据库信息泄露的风险。其实大多的数据库连接池都有对数据库访问密码加解密的功能，因此我们可以通过把数据库访问的密码进行加密来解决安全问题。下面以 `druid` 为例：

1.   修改配置文件

     ```yaml
     spring:
       datasource:
         driver-class-name: com.mysql.cj.jdbc.Driver
         url: jdbc:mysql://127.0.0.1:3306/hello_world?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=UTF-8&useSSL=false
         username: root
         password: xxxxxxxx # 加密过的密码
         
     publicKey: xxxxxxxx # 公钥
     ```

     

2.   修改 druid 配置

     ```xml
     <bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource"
             destroy-method="close">
         ...
         
         <property name="filters" value="stat,config" />  
         <property name="connectionProperties" value="config.decrypt=true;config.decrypt.key=${publickey}" />
         
         ...
     </bean>
     ```

     



#### 数据库数据加密





### 2.2 人员层面