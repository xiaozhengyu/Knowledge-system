# Eureka 理论

[toc]

## 服务治理

RPC 框架中服务间的依赖关系往往比较复杂，因此使用单独的组件专门对服务进行治理

-   服务注册
-   服务发现



## 服务注册 & 服务发现

如果把 Eureka 看作婚姻中介，那么张三将自己的信息挂到中介的过程就相当于服务注册，张三从中介获取其他人的信息就相当于服务发现。



![image-20220210134350740](markdown/Eureka 理论.assets/image-20220210134350740.png)

<center>图左：Eureka 架构   图右：Dubbo架构</center>

|     别名     |                            IP                             |
| :----------: | :-------------------------------------------------------: |
| user_service | xxx.xxx.xxx.xxx<br />xxx.xxx.xxx.xxx<br />xxx.xxx.xxx.xxx |



在服务注册和服务发现过程中，有一个注册中心的角色。服务提供者将自身消息（服务地址、通讯方式、别名…）注册到注册中心。服务消费者根据服务提供者的别名到注册中心查询服务提供者的具体信息（服务地址、通讯方式…），然后在本地完成 RPC 调用。



## EurekaServer & EurekaClient

Euraka 采用的是 CS 架构：

-   Eureka Server 作为服务注册中心，负责对外提供服务注册和服务查询的功能。运维人员可以通过 Eureka Server 监视各个服务节点的是否正常运行。Eureka Client 可以在 Eureka Server 登记自己的信息，也可以查询其他 Client 的信息。

-   Eureka Client 作为客户端，负责将自己的信息（如别名、地址）上报到注册中心，并定时发送心跳（默认每30秒发送一次），Eureka Server 凭据心跳判断服务的健康状态，如果在多个周期内没有接收到心跳，Eureka Service 会将服务节点从服务注册表移除。



## 保护模式

回顾一下在正常情况下，Eureka 的主要工作过程：

1.   Provider 到注册中心登记自己的实例信息（所属的服务、实例别名、IP地址、端口号），Provider 定期向注册中心发送心跳，以表明自己依然正常，能够对外提供服务（处于健康状态）
2.   注册中心暂时保存 Provider 提供的信息，<font color = red>如果长时间没有收到 Provider 的心跳则移除这些信息</font>（默认90s）
3.   Consumer 根据服务名到注册中心查询该服务当前可提供服务的实例信息，然后挑选一个实例进行调用

<img src="markdown/Eureka 理论.assets/image-20220213043304067.png" alt="image-20220213043304067" style="zoom:50%;" />

根据上述第2点的描述，假如出现网络分区（延时、卡顿、拥挤）导致注册中心无法接收 Provider 发送的心跳，注册中心就可能将处于健康的实例移除，<font color = red>进而导致 Consumer 查询不到、调用不到这个健康的实例</font>。为了避免这种情况，Eureka 提供了“自我保护机制”。



官方定义：

>   自我保护模式正是一种针对网络异常波动的安全保护措施，使用自我保护模式能使 Eureka 集群更加的健壮、稳定的运行。



自我保护机制的工作原理：<u>如果在15分钟内超过85%的客户端节点都没有正常的心跳，那么 Eureka 就认为客户端与注册中心出现了网络故障，Eureka Server 自动进入自我保护机制</u>，此时会出现以下几种情况：

1.   Eureka Server 不再从注册列表中移除因为长时间没收到心跳而应该过期的服务实例
2.   Eureka Server 仍然能够接受新服务实例的注册和查询请求，但是不会被同步到其它节点上，保证当前节点依然可用
3.   当网络稳定时，当前 Eureka Server 新的注册信息会被同步到其它节点中

因此 Eureka 可以很好的应对因网络故障导致部分节点失联的情况，而不会像 ZK那样如果有一半不可用的情况会导致整个集群不可用而变成瘫痪。

在 CAP 理论中，Eureka 的自我保护机制属于 <font color = red>AP</font>（可用性 + 分区容错性）
