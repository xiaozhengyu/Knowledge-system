# Redis缓存雪崩、穿透、击穿

参考文章：

1.  [缓存穿透、缓存击穿、缓存雪崩解决方案](https://zhuanlan.zhihu.com/p/359118610)
2.  [进大厂系列-Redis缓存雪崩、击穿、穿透](https://zhuanlan.zhihu.com/p/89961333)

---

为了分担MySQL的读写压力，通常会使用Redis缓存热点数据（如：电商首页、微博热搜）。更新缓存的方案一般有以下两种：方案一，使用定时任务定期更新缓存。方案二，给缓存设置失效时间，失效后更新缓存。

![image-20210907151826095](markdown/Redis缓存雪崩、穿透、击穿.assets/image-20210907151826095.png)

## 缓存穿透

### 怎么发生？

请求缓存和数据库都不存在的数据，请求会打到数据库，并且由于查询不到数据，没法添加缓存，下次请求照样还会打到数据库。此时，缓存起不到作用，就像被“穿透”了一样，不管来多少请求都会打到数据库。在这种情况下，如果请求量和并发量大一些，数据库很可能会被干崩！而且，即使重启数据库也没用——重启，干崩，再重启，再干崩。

```pseudocode
public Station getBook(Integer bookId){
    // A.尝试从缓存中获取数据
    Book book = getBookFromCache(bookId);
    if (book != null){
        return book;
    }
    
    // B.尝试从数据库获取数据
    book = getBookFromDB.get(bookId);    // TODO：缓存击穿风险
    if (book != null){
        // 添加缓存
        saveBookToCache(bookId);
    }
    
    return book;
}
```



### 怎么预防？

1.  **接口校验**。访问不存在key的情况在正常业务流程中可能存在，但一般不会频繁、大量的出现，如果真出现这种情况，极有可能是有人正在恶意攻击系统。因此，可以在系统最外层先加一层校验：用户鉴权、数据合法性校验等，例如，商品的ID都是正整数，那么可以直接将非整数的请求过滤。

2.  **缓存空值**。将数据库中查询不到的key缓存到Redis，然后其对应的value设为空值或其他约定数值，最后，为key设置一个较短的过期时间。

3.  **布隆过滤器**。使用布隆过滤器记录数据库中可能存在的key，每次请求先查看布隆过滤器 ，如果key不存在直接过滤该请求，如果key存在再进一步查询缓存和数据库。

    >   布隆过滤器的特点：判断不存在的，肯定不存在；判断存在的，大概率存在

4.  网关。拉黑访问频率异常的IP



## 缓存击穿

### 怎么发生？

某热点key一直扛着大量的并发请求，在缓存过期的一瞬间，大量的请求直接打到数据库，此时数据库可能被干崩。

### 怎么预防？

1.  **互斥锁**。对数据库查询加互斥锁，避免在太多的查询请求打到数据库。抢不到锁的线程先阻塞，等拿到锁的请求查询到数据并且将数据添加到缓存，直接从缓存取数据。

    关于互斥锁的选择，网上多数文章介绍的都是<u>Redis分布式锁</u>，这种选择可以确保只有一个请求会打到数据库，这是一种思路。但是仔细想想，其实没有必要严格控制只有一个请求打到数据库，只要保证打到数据库的请求数量大大降低就行，所以另外一种思路就是<u>JVM锁</u>。

    JVM锁保证了单台服务器上只有一个请求能够打到数据库，通常来说这就足以保护数据库，同时性能上又比分布式锁更好。

    

2.  **热点数据不过期**。直接将热点数据设置为不过期，然后由定时任务更新数据。这种方式适用于比较极端的场景，例如流量特别特别大的场景，使用时需要考虑业务能接受<u>数据不一致</u>的时间，还有就是异常情况的处理，不要到时候缓存刷新不上，一直是脏数据，那就凉了。



## 缓存雪崩

### 怎么发生？

大量热点数据设置了相同的过期时间，在缓存过期的一瞬间，海量的请求直接打到数据库，将数据库干崩。

缓存雪崩类似缓存击穿的升级版——缓存击穿是一个热点key，缓存雪崩是一组热点key。

缓存击穿更偏重key的热度，例如，key每秒承受10000次请求；缓存雪崩更偏重key的量，例如，100个key同时失效，每个key每秒承受100次请求。



### 怎么预防？

1.  **打散过期时间。**为缓存过期时间增加一个随机值，避免大量key在同一时间失效。
2.  **互斥锁。**
3.  **热点数据不过期。**
