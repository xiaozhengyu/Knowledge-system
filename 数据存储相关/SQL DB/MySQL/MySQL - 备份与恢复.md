# MySQL - 备份与恢复

[toc]

## 备份的意义

备份就是为了防止原数据丢失，保证数据的安全。当数据库因为某些原因造成部分或者全部数据丢失后，备份文件可以帮我们找回丢失的数据。因此，任何数据库都需要备份，备份数据是维护数据库必不可少的操作。

常见数据库备份的应用场景如下：

-   数据丢失应用场景
    -   人为操作失误造成某些数据被误操作
    -   软件 BUG 造成部分数据或全部数据丢失
    -   硬件故障造成数据库部分数据或全部数据丢失
    -   安全漏洞被入侵造成数据被恶意破坏
-   非数据丢失应用场景
    -   特殊应用场景下基于时间点的数据恢复
    -   开发测试环境数据库搭建
    -   相同数据库的新环境搭建
    -   数据库或者数据迁移

## 备份的分类

根据备份的方法（是否需要数据库离线）可以将备份分为：

-   **冷备**（Cold Backup）：在数据库停止的情况下进行备份，备份期间数据库的读写操作不能执行。这种备份最为简单，一般只需要复制相关的数据库物理文件即可。这种方式在 MySQL 官方手册中称为 Offline Backup（离线备份）
-   **温备**（Warm Backup）：在数据库运行的情况下进行备份，但备份期间数据库只能执行读操作
-   **热备**（Hot Backup）：在数据库运行的情况下进行备份，备份期间数据库数据库的读写操作都可以正常执行。这种方式在 MySQL 官方手册中称为 Online Backup（在线备份）

根据本分数据库的内容可以将备份分为：

-   **完全备份**：对数据库进行一个完整的备份，即备份整个数据库，如果数据较多会占用较大的时间和空间
-   **部分备份**：备份部分数据库（例如，只备份一个表）
    -   **增量备份**：指的是在上次完全备份的基础上，对更改的数据进行备份。也就是说每次备份只会备份自上次备份之后到备份时间之内产生的数据。因此每次备份都比差异备份节约空间，但是恢复数据麻烦。增量备份需要使用专业的备份工具
    -   **差异备份**：指的是自上一次完全备份以来变化的数据。和增量备份相比，浪费空间，但恢复数据比增量备份简单

MySQL 中进行不同方式的备份还要考虑存储引擎是否支持，如 MyISAM 不支持热备，支持温备和冷备。而 InnoDB 支持热备、温备和冷备。

一般情况下，我们需要备份的数据分为以下几种：

-   表数据
-   二进制日志、InnoDB 事务日志
-   代码（存储过程、存储函数、触发器、事件调度器）
-   服务器配置文件

下面是几种常用的备份工具：

-   mysqldump：mysql自带的逻辑备份工具，适用于所有的存储引擎，支持温备、完全备份、部分备份、对于 InnoDB 存储引擎支持热备。
-   cp、tar 等归档复制工具：物理备份工具，适用于所有的存储引擎、冷备、完全备份、部分备份。
-   lvm2 snapshot：借助文件系统管理工具进行备份。
-   mysqlhotcopy：名不副实的一个工具，仅支持 MyISAM 存储引擎。
-   xtrabackup：一款由 percona 提供的非常强大的 InnoDB/XtraDB 热备工具，支持完全备份、增量备份。



## 冷备份



## 热备份

与冷备份正好相反，热备份是在数据库处于运行状态时直接备份，不影响现有业务的正常进行。热备份又细分为逻辑备份和裸文件备份，下面我们介绍逻辑备份和冷备份以及它们常用的备份和恢复的方法。

### 逻辑备份

逻辑备份的最大优点就是对于各种存储引擎，都可以用同样的方法来备份。而冷备份则不同，不同的存储引擎的备份方法也各不相同。因此，对于不同存储引擎混合的数据库，用逻辑备份会更简单一些。

逻辑备份可以说是最简单，也是目前中小型系统最常用的备份方法。逻辑备份主要有以下几种方法：

-   **mysqldump**

    mysqldump 是 MySQL 自带的逻辑备份工具。它的备份原理是通过协议连接到 MySQL  数据库，将需要备份的数据查询出来，然后<mark style = "background:#DAE3E9">将查询出的数据转换成对应的 INSERT 语句</mark>。当我们需要还原恢复这些数据时，只要执行这些 INSERT  语句，就能将对应的数据还原。所以有的资料也将这种备份方式称为 INSERT 备份。

    恢复数据时可以使用 `mysql -u root -p <backup.sql` 直接调用备份文件执行所有命令，将数据完全恢复到备份时候的状态。如果已经连接上了 MySQL 服务器，那么可以通过 `source /path/backup.sql` 来进行恢复。

-   **select into…outfile**

    SELECT INTO…OUTFILE 语句可以把表数据导出到一个文本文件中，且能将数据库中的表数据以特定分隔符进行分隔后记录在文本文件中，以达到逻辑备份的效果。

    这种备份方式与 mysqldump  方法相比，使用的存储空间更小，数据格式更加清晰明确，编辑方便。<mark style = "background:#DAE3E9">但是这种方法只能导出或导入数据的内容，不包括表的结构，如果表的结构文件损坏，则必须先恢复原来的表的结构。而且这种方法不能在同一个备份文件中存在多个表的备份数据，增加了文件维护和恢复的成本。</mark>

    这种备份方法恢复起来会稍微麻烦一点，需要一个表一个表通过相关命令来进行恢复。当然如果是通过脚本来实现自动多表恢复也是比较方便的。恢复方法有 2  个，一个是通过 MySQL 的 LOAD DATA INFILE 命令来恢复数据，另一种方法就是通过 MySQL 提供的使用工具  mysqlimport 来进行恢复。

-   **mydump**

    mydumper 是针对 MySQL 数据库备份的一个轻量级第三方的开源工具，备份方式为逻辑备份。它支持多线程，备份速度远高于原生态的  mysqldump 以及其它众多优异特性。与其配套的相应恢复数据为 myloader 工具。DBA 称 mydumper 和 myloader  为备份界的“小钢炮”。

我们可以看出所谓的逻辑备份就是备份 SQL 语句，然后恢复数据时执行备份 SQL，从而实现数据库数据的重现。逻辑备份完成后所形成的文件都可以直接编辑。

逻辑备份的作用如下：

-   通过逻辑备份，我们可以仅仅恢复备份中的部分数据而不需要全部恢复。不会影响不相关的数据
-   通过全库的逻辑备份，我们可以在新的 MySQL 环境下完全重建出一个与备份时完全一样的数据库，并且不受平台类型限制
-   通过特定条件的逻辑备份，我们可以将某些特定数据轻松迁移（或者同步）到其它的 MySQL 或另外的数据库环境

### 裸文件备份

裸文件备份主要在底层复制数据文件，所以备份速度要比逻辑备份更快。

我们利用 Percona 公司发布的一个 XtraBackup 热备份工具来完成裸文件备份，它是 Percona 公司的开源项目，据官方介绍它是世界上唯一 一款开源的能够对 InnoDB 和 XtraDB 数据库进行热备的工具。

它的优点就是备份与恢复过程的速度很快，安全可靠，而且在备份过程中不会缩表，不影响现有业务。但它目前还是不能对表结构文件和其它非事务类型的表进行备份。

