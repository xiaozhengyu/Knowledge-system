# MySQL 自增主键一定是连续递增的吗？

[TOC]

## 一、前言

### 1.1 存储引擎与主键自增

在 MySQL 中，不同的存储引擎实现主键自增的方式是不同的，下面分别介绍 InnoDB 和 MyISAM 存储引擎的实现方式。

#### 1.1.1 InnoDB 实现主键自增的方式

InnoDB 存储引擎中，主键自增是通过使用自增计数器和锁机制实现的。InnoDB 存储引擎会在==内存==中缓存一个自增计数器，每次插入一行数据时，就会将自增计数器的值加一，并将这个值作为新行的主键值。在并发情况下，InnoDB 存储引擎会使用互斥锁（Mutex）来保证自增计数器的唯一性，从而避免并发插入时出现重复的主键值。

需要注意的是，数据库重启后所有在内容中的计数器和缓存都会被清空，因此 InnoDB 存储引擎需要重新准备自增计数器：从持久化存储中读取表中的最大自增值，并将其加一。

#### 1.1.2 MyISAM 实现主键自增的方式

与 InnoDB 存储引擎不同，MyISAM 存储引擎中，主键自增是通过将自增值保存在==磁盘==上实现的。每次插入一行数据时，MyISAM  存储引擎会读取磁盘上保存的自增值，并将其加一作为新行的主键值。在并发情况下，MyISAM 存储引擎会使用表级锁（Table-level  Lock）来保证自增值的唯一性，从而避免并发插入时出现重复的主键值。

需要注意的是，MyISAM 存储引擎在某些情况下可能会出现自增值重复的情况，例如在进行表维护操作时（如修复表、优化表等）或者在高并发插入数据的情况下。因此，如果需要保证主键的唯一性，建议使用 InnoDB 存储引擎。

### 1.2 自增主键不一定连续自增

在 MySQL 中，自增主键并不一定是连续自增的。自增主键无法连续自增的情况主要包括以下几种：

1.  插入失败：当插入数据时，因为某种原因（如重复键或类型不匹配），插入失败会导致自增主键的编号不连续。
2.  回滚事务：当使用事务时，如果在提交之前回滚事务，则已分配但未使用的自增主键也会被释放，从而导致自增主键编号不连续。
3.  删除数据：当删除表中的某些行时，与这些行相关的自增主键也会被删除，导致自增主键编号不连续。
4.  手动指定主键值：如果在插入数据时手动指定主键值，而不是使用自增主键生成的值，则可能导致自增主键编号不连续。
5.  批量插入数据：当使用批量插入数据的语句（如insert ... select）时，因为每次申请的自增id数量不确定，也可能导致自增主键编号不连续。

需要注意的是，自增主键编号不连续并不会影响数据的正确性和完整性，只是会影响到主键的值是否连续。如果需要保证主键的连续性，可以考虑使用其他方式生成主键，如UUID或时间戳等。

## 二、正文



